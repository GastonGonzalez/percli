#!/usr/bin/env node

var fs      = require('fs-extra')
var args    = require('commander')
var axios   = require('axios')
var asciify = require('asciify')

args.version('1.0.0')
//	.option('-f, --force', 'force the installation')
	.parse(process.argv)

/* functions that return promises dont need to be async */

/* Step 1 ==========
==================== */
async function getBanner(){
    return asciify('peregrine cms', {font:'big'}, function(err, res){ console.log(res) });
}

/* Step 2 ==========
==================== */
function getSlingExe(){
    return new Promise( (resolve, reject) => {
        axios({
          method:'get',
          url: 'https://vagrant.headwire.com/sling/9/org.apache.sling.launchpad-9.jar',
          responseType:'stream'
        })
        .then(function(res) {
          let stream = res.data.pipe(fs.createWriteStream('out/sling-9.jar'))
          stream.on('finish', () => { console.log('sling-9 download complete'); resolve() })
        })
        .catch(err => console.log('download err: ', 'sling-9.jar'))
    })
}

/* Step 3 ==========
==================== */
function getPackageList(){
    return axios.get('https://vagrant.headwire.com/peregrine/packages.txt')
}

/* Step 4 ==========
==================== */
function downloadPackages(packages){
    var lines = packages.split('\n')
    /* create array of requests, axios will d/l them in parallel with axios.all */
    return axios.all(lines.map(line => {
        if(line.length === 0) return Promise.resolve
        return axios({
          method:'get',
          url: 'https://vagrant.headwire.com/peregrine/' + line,
          responseType:'stream'
        })
        .then(function(res) {
          res.data.pipe(fs.createWriteStream('out/' +line))
        })
        .catch(err => console.log('download err: ', line))
    }))
}

/* Step 5 ==========
==================== */
async function installPackages(packages){
    console.log('time to install')
}

/* Flow Control ==========
========================== */
async function serverInstall() {  
  try {
    // step 1
    await getBanner()
    // step 2
    await getSlingExe()
    // step 3
    let packagesList = await getPackageList()
    // step 4
    await downloadPackages(packagesList.data)
    // step 5
    await installPackages()
  } catch (err) {
    console.error('serverInstall err')
  }
}

serverInstall()
