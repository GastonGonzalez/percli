#!/usr/bin/env node

var fs      = require('fs')
var args    = require('commander')
var axios   = require('axios')
var asciify = require('asciify')

args.version('1.0.0')
//	.option('-f, --force', 'force the installation')
	.parse(process.argv)

/* functions that return promises dont need to be async */

/* Step 0 ==========
==================== */
async function getBanner(){
    return asciify('peregrine cms', {font:'big'}, function(err, res){ console.log(res) });
}

/* Step 0.5 ========
==================== */
function getSlingExe(){
    return axios({
      method:'get',
      url: 'https://vagrant.headwire.com/sling/9/org.apache.sling.launchpad-9-SNAPSHOT.jar',
      responseType:'stream'
    })
    .then(function(res) {
      res.data.pipe(fs.createWriteStream('out/launchpad-9-SNAPSHOT.jar'))
    })
    .catch(err => console.log('download err: ', 'launchpad-9-SNAPSHOT.jar'))
}

/* Step 1 ==========
==================== */
function getPackageList(){
    return axios.get('https://vagrant.headwire.com/peregrine/packages.txt')
}

/* Step 2 ==========
==================== */
function downloadPackages(packages){
    var lines = packages.split('\n')
    /* create array of requests, axios will d/l them in parallel with axios.all */
    return axios.all(lines.map(line => {
        return axios({
          method:'get',
          url: 'https://vagrant.headwire.com/peregrine/' + line,
          responseType:'stream'
        })
        .then(function(res) {
          res.data.pipe(fs.createWriteStream('out/' +line))
        })
        .catch(err => console.log('download err: ', line))
    }))
}

/* Step 3 ==========
==================== */
async function installPackages(packages){
    console.log('time to install')
}

/* Flow Control ==========
========================== */
async function serverInstall() {  
  try {
    // step 0
    await getBanner()
    // step 0.5
    await getSlingExe()
    // step 1
    let packagesList = await getPackageList()
    // step 2
    await downloadPackages(packagesList.data)
    // step 3
    await installPackages()
  } catch (err) {
    console.error('serverInstall err')
  }
}

serverInstall()
