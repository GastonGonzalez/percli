#!/usr/bin/env node

const fs   = require('fs-extra')
const args = require('commander')
const { 
  startPeregrine, 
  getPackageList, 
  installPackages 
} = require('../lib/tasks')
const { 
  peregrineBanner 
} = require('../lib/banner')
const { 
  downloadFile, 
  downloadFiles 
} = require('../lib/fetch')

args.version('1.0.0')
  .option('-d, --download', 'only download')
  .option('-e, --existing', 'install on running server')
  .option('-i, --install',  'only install')
  .parse(process.argv)

/* Flow Control ==========
========================== */
async function serverInstall() {
  fs.mkdirsSync('out')
  try {
    if(!args.install) {
        // step 1
        await peregrineBanner()
        console.log('step1 complete: banner displayed')

        // step 2
        var packagesList = await getPackageList()
        console.log('step2 complete: package list =', packagesList)

        //step 3
        await downloadFile('https://vagrant.headwire.com/sling/9/org.apache.sling.launchpad-9.jar', 'sling-9.jar')
        console.log('step3 complete: file downloaded')

        // step 4
        await downloadFiles(packagesList)
        console.log('step4 complete: files downloaded')
    }

    if(!args.download) {

        if(!args.existing) {
            // step 5
            await startPeregrine()
            console.log('step5 complete: tasks complete')
        }

        // step 6
        await installPackages(packagesList)
        console.log('step6 complete: packages installed')
    }

  } catch (err) {
    console.error('serverInstall err')
    console.error(err)
  }
}

serverInstall()
